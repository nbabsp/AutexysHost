<!DOCTYPE html>
<html>
<head>
	<title>User Interface</title>
	<link href='https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Material+Icons' rel="stylesheet">
	<link href="/ui/vuetify.css" rel="stylesheet">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
	
	<meta http-equiv="cache-control" content="no-cache, must-revalidate, post-check=0, pre-check=0" />
	<meta http-equiv="cache-control" content="max-age=0" />
	<meta http-equiv="expires" content="0" />
	<meta http-equiv="pragma" content="no-cache" />
	
	<style media="screen" type="text/css">
		html {
			overscroll-behavior: none;
		}
		
		[v-cloak] > * {
			display: none;
		}

		.fade-leave-active, .fade-enter-active {
			transition: 0.7s ease;
		}
		.fade-leave-to {
			opacity: 1;
		}
		.fade-enter, .fade-leave {
			opacity: 0;
		}
		
		.loaderfadeaway-enter-active .loaderfadeaway-leave-active {
			transition: opacity .5s;
		}
		.loaderfadeaway-enter, .loaderfadeaway-leave-to {
			opacity: 0;
		}
		
		.spinner {
			margin: 100px auto;
			width: 40px;
			height: 40px;
			position: relative;
			text-align: center;
			
			-webkit-animation: sk-rotate 2.0s infinite linear;
			animation: sk-rotate 2.0s infinite linear;
		}
		.dot1, .dot2 {
			width: 60%;
			height: 60%;
			display: inline-block;
			position: absolute;
			top: 0;
			background-color: #333;
			border-radius: 100%;
			
			-webkit-animation: sk-bounce 2.0s infinite ease-in-out;
			animation: sk-bounce 2.0s infinite ease-in-out;
		}
		.dot2 {
			top: auto;
			bottom: 0;
			-webkit-animation-delay: -1.0s;
			animation-delay: -1.0s;
		}
		@-webkit-keyframes sk-rotate { 100% { -webkit-transform: rotate(360deg) }}
		@keyframes sk-rotate { 100% { transform: rotate(360deg); -webkit-transform: rotate(360deg) }}
		@-webkit-keyframes sk-bounce {
			0%, 100% { -webkit-transform: scale(0.0) }
			50% { -webkit-transform: scale(1.0) }
		}
		@keyframes sk-bounce {
			0%, 100% { 
				transform: scale(0.0);
				-webkit-transform: scale(0.0);
			} 50% { 
				transform: scale(1.0);
				-webkit-transform: scale(1.0);
			}
		}
		
		img {
			width: auto;
			height: auto;
			max-width: 100%;
			margin-left: auto;
			margin-right: auto;
		}
		
		.zoomableImage:hover {
			opacity: 0.7;
			transition: opacity 0.5s;
		}
		.zoomedImage {
			position: fixed;
			z-index: 500;
			background-color: rgb(255,255,255);
			max-width: 80vw;
			max-height: 90vh;
			top: 50vh;
			right: 50vw;
			transform: translate(50%, -50%);
		}
	</style>
</head>
<body>
	<div id="app">
		
		<transition name="loaderfadeaway">
		<div style="height:100%; width: 100%; z-index: 1000; position: absolute; background-color: rgb(255,255,255);" v-if="pageLoading">
			<div class="spinner">
				<div class="dot1"></div>
				<div class="dot2"></div>
			</div>
		</div>
		</transition>
		
	<transition name="fade" mode="out-in" appear>
		<v-app v-cloak>
				<v-navigation-drawer clipped fixed v-model="drawer" class="blue-grey lighten-1" dark app>
					<v-list dense>
						<v-list-tile @click="setTopLevelPage('dashboard')">
							<v-list-tile-action>
								<v-icon>dashboard</v-icon>
							</v-list-tile-action>
							<v-list-tile-content>
								<v-list-tile-title>Dashboard</v-list-tile-title>
							</v-list-tile-content>
						</v-list-tile>
						<v-list-tile @click="setTopLevelPage('stepper')">
							<v-list-tile-action>
								<v-icon>list</v-icon>
							</v-list-tile-action>
							<v-list-tile-content>
								<v-list-tile-title>Browser</v-list-tile-title>
							</v-list-tile-content>
						</v-list-tile>
						<v-list-tile @click="setTopLevelPage('scheduleCreator')">
							<v-list-tile-action>
								<v-icon>schedule</v-icon>
							</v-list-tile-action>
							<v-list-tile-content>
								<v-list-tile-title>Schedule Creator</v-list-tile-title>
							</v-list-tile-content>
						</v-list-tile>
						<v-list-tile @click="setTopLevelPage('experimentRunner')">
							<v-list-tile-action>
								<v-icon>play_circle_outline</v-icon>
							</v-list-tile-action>
							<v-list-tile-content>
								<v-list-tile-title>Experiment Runner</v-list-tile-title>
							</v-list-tile-content>
						</v-list-tile>
						<v-list-tile @click="setTopLevelPage('settings')">
							<v-list-tile-action>
								<v-icon>settings</v-icon>
							</v-list-tile-action>
							<v-list-tile-content>
								<v-list-tile-title>Settings</v-list-tile-title>
							</v-list-tile-content>
						</v-list-tile>
						<v-list-tile @click="setTopLevelPage('about')">
							<v-list-tile-action>
								<v-icon>info_outline</v-icon>
							</v-list-tile-action>
							<v-list-tile-content>
								<v-list-tile-title>About</v-list-tile-title>
							</v-list-tile-content>
						</v-list-tile>
					</v-list>
				</v-navigation-drawer>
				<v-toolbar app fixed clipped-left dark color="blue-grey darken-1">
					<v-toolbar-side-icon @click.stop="drawer = !drawer"></v-toolbar-side-icon>
					<v-toolbar-title>Autexys User Interface</v-toolbar-title>
					<v-spacer></v-spacer>
					<v-toolbar-items>
						<v-menu bottom left offset-y :close-on-content-click="false" :nudge-width="200">
							<v-btn slot="activator" flat><v-icon>art_track</v-icon></v-btn>
							<v-card light>
								<v-list>
									<v-list-tile v-for="plotSettingValue, plotSettingName in setPlotSettings">
										<v-switch v-if="plotSettingTypes[plotSettingName]['type'] == 'bool'" :label="plotSettingName" v-model="setPlotSettings[plotSettingName]"></v-switch>
										<v-text-field v-if="plotSettingTypes[plotSettingName]['type'] == 'int'" :label="plotSettingName" v-model.number="setPlotSettings[plotSettingName]" type="number"></v-text-field>
										<v-text-field v-if="plotSettingTypes[plotSettingName]['type'] == 'float'" :label="plotSettingName" v-model.number="setPlotSettings[plotSettingName]" type="number"></v-text-field>
										<v-text-field v-if="plotSettingTypes[plotSettingName]['type'] == 'array'" :label="plotSettingName" v-model="setPlotSettings[plotSettingName]"></v-text-field>
										<v-text-field v-if="plotSettingTypes[plotSettingName]['type'] == 'object'" :label="plotSettingName" v-model="setPlotSettings[plotSettingName]"></v-text-field>
										<v-select v-if="plotSettingTypes[plotSettingName]['type'] == 'choice'" :label="plotSettingName" :items="plotSettingTypes[plotSettingName]['choices']" v-model="setPlotSettings[plotSettingName]"></v-select>
									</v-list-tile>
									<v-list-tile>
										<v-btn @click="setPlotSettings = JSON.parse(JSON.stringify(defaultPlotSettings))">Reset</v-btn>
										<v-spacer></v-spacer>
										<v-btn @click="updatePlotSettings()">Save</v-btn>
									</v-list-tile>
								</v-list>
							</v-card>
						</v-menu>
						<v-menu bottom left offset-y>
							<v-btn slot="activator" flat>{{ user }}<v-icon right>people</v-icon></v-btn>
							<v-card style="max-height:85vh">
								<v-list light>
									<v-list-tile v-for="u in users" @click="goToUser(u)">
										<v-list-tile-avatar color="blue-grey lighten-2"><v-icon dark>account_circle</v-icon></v-list-tile-avatar>
										<v-list-tile-content><v-list-tile-title>{{ u }}</v-list-tile-title></v-list-tile-content>
									</v-list-tile>
								</v-list>
							</v-card>
						</v-menu>
					</v-toolbar-items>
				</v-toolbar>
				<v-content>
					
					<v-stepper v-if="topLevelPage == 'stepper'" v-model="stepperPage" style="background-color:rgba(255,255,255,0);height:100%;">
						<v-stepper-header style="background-color:rgba(255,255,255,1);">
							<v-stepper-step step="1" :complete="stepperPage > 1" :editable="stepperPage > 1">Projects</v-stepper-step>
							<v-divider></v-divider>
							<v-stepper-step step="2" :complete="stepperPage > 2" :editable="stepperPage > 2">Wafers</v-stepper-step>
							<v-divider></v-divider>
							<v-stepper-step step="3" :complete="stepperPage > 3" :editable="stepperPage > 3">Chips</v-stepper-step>
							<v-divider></v-divider>
							<v-stepper-step step="4" :complete="stepperPage > 4" :editable="stepperPage > 4">Devices</v-stepper-step>
							<v-divider></v-divider>
							<v-stepper-step step="5" :complete="stepperPage > 5" :editable="stepperPage > 5">Experiments</v-stepper-step>
							<v-divider></v-divider>
							<v-stepper-step step="6" :complete="stepperPage > 6" :editable="stepperPage > 6">Experiment</v-stepper-step>
						</v-stepper-header>
						
						<v-stepper-items>
							
							<v-stepper-content step="1">
								<v-card v-if="stepperPage > 0">
									<v-toolbar dark class="blue-grey darken-1">
										<v-toolbar-title>
											Projects
										</v-toolbar-title>
										<v-spacer></v-spacer>
										<v-text-field v-model="projectTableSearch" append-icon="search" label="Search" single-line hide-details></v-text-field>
										<v-btn icon @click="getAll()"><v-icon>refresh</v-icon></v-btn>
									</v-toolbar>
									<v-data-table :items="projects" :headers="projectTableHeaders" :search="projectTableSearch" must-sort
										:rows-per-page-items="[10,20,50,{'text':'$vuetify.dataIterator.rowsPerPageAll','value':-1}]"
										no-results-text="Your search did not return any results."
										:custom-filter="customVDataTableFilter">
										<template slot="items" slot-scope="props">
											<tr @click="goToProject(props.item.name)">
												<td>{{ props.item.name }}</td>
											</tr>
										</template>
									</v-data-table>
								</v-card>
							</v-stepper-content>
							
							<v-stepper-content step="2">
								<v-card v-if="stepperPage > 1">
									<v-toolbar dark class="blue-grey darken-1">
										<v-btn icon @click="stepperPage--; getProjects()"><v-icon>arrow_back</v-icon></v-btn>
										<v-toolbar-title>
											Wafers
										</v-toolbar-title>
										<v-spacer></v-spacer>
										<v-text-field v-model="waferTableSearch" append-icon="search" label="Search" single-line hide-details></v-text-field>
										<v-btn icon @click="getAll()"><v-icon>refresh</v-icon></v-btn>
									</v-toolbar>
									<v-data-table :items="wafers" :headers="waferTableHeaders" :search="waferTableSearch" must-sort
										:rows-per-page-items="[10,20,50,{'text':'$vuetify.dataIterator.rowsPerPageAll','value':-1}]"
										no-results-text="Your search did not return any results."
										:custom-filter="customVDataTableFilter">
										<template slot="items" slot-scope="props">
											<tr @click="goToWafer(props.item.name)">
												<td>{{ props.item.name }}</td>
												<td>{{ props.item.path }}</td>
												<td>{{ new Date(props.item.modificationTime*1000).toLocaleString() }}</td>
												<td>{{ props.item.size }}</td>
												<td>{{ props.item.chipCount }}</td>
												<td>{{ props.item.indexCount }}</td>
												<td>{{ props.item.experimentCount }}</td>
											</tr>
										</template>
									</v-data-table>
								</v-card>
							</v-stepper-content>
							
							<v-stepper-content step="3">
								<v-card v-if="stepperPage > 2">
									<v-toolbar dark class="blue-grey darken-1">
										<v-btn icon @click="stepperPage--; getWafers()"><v-icon>arrow_back</v-icon></v-btn>
										<v-toolbar-title>
											{{ wafer }} Chips
										</v-toolbar-title>
										<v-spacer></v-spacer>
										<v-text-field v-model="chipTableSearch" append-icon="search" label="Search" single-line hide-details></v-text-field>
										<v-btn icon @click="getAll()"><v-icon>refresh</v-icon></v-btn>
									</v-toolbar>
									<v-data-table :items="chips" :headers="chipTableHeaders" :search="chipTableSearch" must-sort
										:rows-per-page-items="[10,20,50,{'text':'$vuetify.dataIterator.rowsPerPageAll','value':-1}]"
										no-results-text="Your search did not return any results."
										:custom-filter="customVDataTableFilter">
										<template slot="items" slot-scope="props">
											<tr @click="goToChip(props.item.name)">
												<td>{{ props.item.name }}</td>
												<td>{{ props.item.path }}</td>
												<td>{{ new Date(props.item.modificationTime*1000).toLocaleString() }}</td>
												<td>{{ props.item.size }}</td>
												<td>{{ props.item.deviceCount }}</td>
												<td>{{ props.item.indexCount }}</td>
												<td>{{ props.item.experimentCount }}</td>
											</tr>
										</template>
									</v-data-table>
								</v-card>
							</v-stepper-content>
							
							<v-stepper-content step="4">
								<v-card v-if="stepperPage > 3">
									<v-toolbar dark class="blue-grey darken-1">
										<v-btn icon @click="stepperPage--; getChips();"><v-icon>arrow_back</v-icon></v-btn>
										<v-toolbar-title>
											{{ wafer }}{{ chip }} Devices
										</v-toolbar-title>
										<v-spacer></v-spacer>
										<v-text-field v-model="deviceTableSearch" append-icon="search" label="Search" single-line hide-details></v-text-field>
										<v-btn icon @click="getAll()"><v-icon>refresh</v-icon></v-btn>
									</v-toolbar>
									<v-data-table :items="devices" :headers="deviceTableHeaders" :search="deviceTableSearch" must-sort
										:rows-per-page-items="[10,20,50,{'text':'$vuetify.dataIterator.rowsPerPageAll','value':-1}]"
										no-results-text="Your search did not return any results."
										:custom-filter="customVDataTableFilter">
										<template slot="items" slot-scope="props">
											<tr @click="goToDevice(props.item.name)">
												<td>{{ props.item.name }}</td>
												<td>{{ props.item.path }}</td>
												<td>{{ new Date(props.item.modificationTime*1000).toLocaleString() }}</td>
												<td>{{ props.item.size }}</td>
												<td>{{ props.item.indexCount }}</td>
												<td>{{ props.item.experimentCount }}</td>
											</tr>
										</template>
									</v-data-table>
								</v-card>

								<v-card v-if="stepperPage == 4 ">
									<v-toolbar dark class="blue-grey darken-1">
										<v-toolbar-title>
											{{ wafer }}{{ chip }} Chip Summary Plots
										</v-toolbar-title>
									</v-toolbar>
									
									<!-- container gives a couple chip summary plots that present data from all experiments on this chip for comparisson (sn)-->
									
									<v-container fluid grid-list-sm>
											<v-layout row wrap>
												<v-flex xs12 sm6 md4 lg3 xl2 d-flex v-for="possiblePlot in possibleChipPlots">
													<v-card class="ma-1" tile>
														<v-toolbar dark class="blue-grey lighten-1">
															<v-toolbar-title>
																 {{ possiblePlot }}
															</v-toolbar-title>
														</v-toolbar>
														<div class="text-xs-center">
															<zoomable-image src="" :data-src="'/chipPlots/'+user+'/'+project+'/'+wafer+'/'+chip+'/'+possiblePlot + cacheBust + '&plotSettings=' + encodeURI(JSON.stringify(plotSettings))"></zoomable-image>
														</div>
													</v-card>
												</v-flex>
											</v-layout>
									</v-container>

								</v-card>

							</v-stepper-content>


							
							<v-stepper-content step="5">
								<v-card v-if="stepperPage > 4">
									<v-toolbar dark class="blue-grey darken-1">
										<v-btn icon @click="stepperPage--; getDevices();"><v-icon>arrow_back</v-icon></v-btn>
										<v-toolbar-title>
											{{ wafer }}{{ chip }} {{ device }} Experiments
										</v-toolbar-title>
										<v-spacer></v-spacer>
										<v-text-field v-model="experimentTableSearch" append-icon="search" label="Search" single-line hide-details></v-text-field>
										<v-btn icon @click="getAll()"><v-icon>refresh</v-icon></v-btn>
									</v-toolbar>
									<v-data-table :items="experimentsWithIndexes" :headers="experimentTableHeaders" :search="experimentTableSearch" must-sort
										:rows-per-page-items="[10,20,50,{'text':'$vuetify.dataIterator.rowsPerPageAll','value':-1}]"
										no-results-text="Your search did not return any results."
										:custom-filter="customVDataTableFilter"
										:pagination.sync="experimentTablePagination">

										<template slot="items" slot-scope="props">
											<tr @click="goToExperiment(props.item.i)">
												<td>{{ props.item.startIndexes.experimentNumber }}</td>
												<td>{{ props.item.runType }}<template v-if="props.item.parametersHistoryGenerated && props.item.experimentNumber == experiments[experiments.length-1].experimentNumber"> - Running</template></td>
												<td>{{ props.item.MeasurementSystem.systemType }}</td>
												<td>{{ props.item.uiComputed.indexCount }}</td>
												
											</tr>
										</template>
										
									</v-data-table>
								</v-card>
								
								<v-card v-if="stepperPage == 5">
									<v-toolbar dark class="blue-grey darken-1">
										<v-toolbar-title>
											{{ wafer }}{{ chip }} {{ device }} Device Summary Plots
										</v-toolbar-title>
									</v-toolbar>
									
									<!-- container gives a couple summary plots that present data from all experiments on this device for comparisson (sn)-->
									<!-- [Re: need to find way to use proper experiment item (nc)] Since we are doing a summary plot, there will essentially be one plot that shows all the experiments, instead of a plot for each experiment.  I may not have made that clear previously... In the end we may want a couple summary plots, but to begin with lets just get one working. (sn)-->
									<v-container fluid grid-list-sm>
											<!-- <v-layout row wrap>
												<v-flex xs12 sm6 md4 lg3 xl2 d-flex v-for="possiblePlot in experiment.possiblePlots">
													<v-card class="ma-1" tile>
														<v-toolbar dark class="blue-grey lighten-1">
															<v-toolbar-title>
																 {{ possiblePlot }}
															</v-toolbar-title>
														</v-toolbar> 
														<div class="text-xs-center">
															<zoomable-image :src="'/plots/'+user+'/'+project+'/'+wafer+'/'+chip+'/'+device+'/'+experiment.startIndexes.experimentNumber+'/'+possiblePlot + cacheBust + '&plotSettings=' + encodeURI(JSON.stringify(deviceSummaryPlotSettings))"></zoomable-image>
														</div>
													</v-card>
												</v-flex>
											</v-layout> -->
									</v-container>
								</v-card>
								
							</v-stepper-content>
							
							<v-stepper-content step="6">
								<v-card v-if="stepperPage > 5 && experiments.length > experimentIndex">
									<v-toolbar dark class="blue-grey darken-1">
										<v-btn icon @click="stepperPage--; getExperiments();"><v-icon>arrow_back</v-icon></v-btn>
										<v-toolbar-title>
											{{ wafer }}{{ chip }} {{ device }} Experiment #{{ experiment.startIndexes.experimentNumber }}
										</v-toolbar-title>
										<v-btn icon @click="experimentIndex--" :disabled="experimentIndex <= 0" class="ml-4"><v-icon>arrow_back_ios</v-icon></v-btn>
										<v-btn icon @click="experimentIndex++" :disabled="experimentIndex >= experiments.length - 1"><v-icon>arrow_forward_ios</v-icon></v-btn>
										<v-spacer></v-spacer>
										<v-btn icon @click="getAll(); newCacheBust();"><v-icon>refresh</v-icon></v-btn>
									</v-toolbar>
									
									<v-container fluid grid-list-sm>
										<v-layout row wrap>
											
											<v-flex xs12 sm6 md4 lg3 xl2 d-flex v-for="possiblePlot in experiment.possiblePlots">
												<v-card class="ma-1" tile>
													<v-toolbar dark class="blue-grey lighten-1">
														<v-toolbar-title>
															{{ possiblePlot }}
														</v-toolbar-title>
														
														<v-spacer></v-spacer>
														
														<v-menu bottom left offset-y>
															<v-btn slot="activator" icon :loading="false"><v-icon>settings</v-icon></v-btn>
															<!-- !this.$parent.getElementsByClassName('zoomableImage')[0].complete -->
															<v-list light>
																<v-list-tile @click="copyHTMLImageToClip('/plots/'+user+'/'+project+'/'+wafer+'/'+chip+'/'+device+'/'+experiment.startIndexes.experimentNumber+'/'+possiblePlot + cacheBust + '&plotSettings=' + encodeURI(JSON.stringify(plotSettings)))">
																	<v-list-tile-avatar>
																		<v-icon>photo</v-icon>
																	</v-list-tile-avatar>
																	<v-list-tile-content><v-list-tile-title>
																		Copy
																	</v-list-tile-title></v-list-tile-content>
																</v-list-tile>
																
																<v-list-tile @click="disabledPlots.push(possiblePlot)">
																	<v-list-tile-avatar>
																		<v-icon>photo</v-icon>
																	</v-list-tile-avatar>
																	<v-list-tile-content><v-list-tile-title>
																		Disable
																	</v-list-tile-title></v-list-tile-content>
																</v-list-tile>
																
																<v-list-tile @click="removeValueFromArray(possiblePlot, disabledPlots)">
																	<v-list-tile-avatar>
																		<v-icon>photo</v-icon>
																	</v-list-tile-avatar>
																	<v-list-tile-content><v-list-tile-title>
																		Enable
																	</v-list-tile-title></v-list-tile-content>
																</v-list-tile>
															</v-list>
														</v-menu>
														
													</v-toolbar>
													<div class="text-xs-center" v-if="!disabledPlots.includes(possiblePlot)">
														<!-- <img :src="'/plots/'+user+'/'+project+'/'+wafer+'/'+chip+'/'+device+'/'+experiment.startIndexes.experimentNumber+'/'+possiblePlot + cacheBust" @click="console.log('clicked image')"> -->
														<zoomable-image src="" :data-src="'/plots/'+user+'/'+project+'/'+wafer+'/'+chip+'/'+device+'/'+experiment.startIndexes.experimentNumber+'/'+possiblePlot + cacheBust + '&plotSettings=' + encodeURI(JSON.stringify(plotSettings))"></zoomable-image>
													</div>
												</v-card>
											</v-flex>
											
										</v-layout>
									</v-container>
									
									
									<!-- <v-container fluid grid-list-sm>
										<v-layout row wrap>
											<v-flex xs12 md6 lg4 xl3 d-flex v-for="section in _.keys(experiment)" v-if="typeof experiment[section] == 'object'">
												<v-card class="ma-1" tile>
													<v-card-title>{{ section }}</v-card-title>
													<v-data-table :items="_.toPairs(experiment[section])" :headers="[{'text':'Property'},{'text':'Value'}]" hide-actions hide-headers>
														<template slot="items" slot-scope="props">
															<td> {{ props.item[0] }}</td>
															<td> {{ props.item[1] }}</td>
														</template>
													</v-data-table>
												</v-card>
											</v-flex>
										</v-layout>
									</v-container> -->
									
									<v-card class="ma-1">
										<v-toolbar dark class="blue-grey darken-1">
											<v-toolbar-title>
												Notes
											</v-toolbar-title>
										</v-toolbar>
										<v-text-field v-model="experiment.noteAddition"></v-text-field>
										<v-btn @click="addToNote(experiment)">Save</v-btn>
									</v-card>
									
									
									<v-card class="ma-1" v-if="experiment.runType.includes('AFM') || experiment.runType.includes('SGM')">
										<v-toolbar dark class="blue-grey darken-1">
											<v-toolbar-title>
												Corresponding AFM Images
											</v-toolbar-title>
										</v-toolbar>
										<div>
											V<sub>GS</sub> = {{_.get(experiment, 'runConfigs.' + experiment['runType'] + '.gateVoltageSetPoint', '')}} V</br>
											V<sub>DS</sub> = {{_.get(experiment, 'runConfigs.' + experiment['runType'] + '.drainVoltageSetPoint', '')}} V</br>
											V<sub>tip</sub> = {{_.get(experiment, 'associatedAFMs.bestMatch.NapTipVoltage', '')}} V</br>
											d<sub>tip</sub> = {{1e9*_.get(experiment, 'associatedAFMs.bestMatch.NapHeight', '')}} nm</br>
										</div>
										
									</v-card>
									
									<v-card class="ma-1">
										<v-expansion-panel dark expand>
											<v-expansion-panel-content class="blue-grey darken-1" v-for="section in _.keys(experiment)" v-if="typeof experiment[section] == 'object'" ripple>
												<div slot="header">{{ section }}</div>
												<v-data-table :items="_.toPairs(experiment[section])" :headers="[{'text':'Property'},{'text':'Value'}]" hide-actions hide-headers light>
													<template slot="items" slot-scope="props">
														<td> {{ props.item[0] }}</td>
														<td> {{ props.item[1] }}</td>
													</template>
												</v-data-table>
											</v-expansion-panel-content>
										</v-expansion-panel>
									</v-card>
									
									<v-card class="ma-1">
										<v-toolbar dark class="blue-grey darken-1">
											<v-toolbar-title>
												Data Export
											</v-toolbar-title>
										</v-toolbar>
										<v-card-actions>
											<v-btn :href="'/saveCSV/'+user+'/'+project+'/'+wafer+'/'+chip+'/'+device+'/'+experiment.startIndexes.experimentNumber+'/data.csv' + cacheBust + '&plotSettings=' + encodeURI(JSON.stringify(plotSettings))">Save CSV</v-btn>
											
											<v-btn @click="updateAFMRegistry()">Update AFM Registry</v-btn>
										</v-card-actions>
										
										<p>This experiment has the following data files: {{ experiment['dataFiles'] }}</p>
										<p>The data for this experiment is stored in <a :href="'file://///' + experiment['dataFolderSpecificAbs']">{{ experiment['dataFolderSpecificAbs'] }}</a></p>
										<p>To load data, use:</p>
										<p>from utilities import DataLoggerUtility as dlu</p>
										<p>
											dlu.loadSpecificDeviceHistory('{{ experiment['dataFolderSpecific'] }}', '{{ experiment['dataFiles'][0] }}', minIndex=0, maxIndex=float('inf'), minExperiment={{ experiment.startIndexes.experimentNumber }}, maxExperiment={{ experiment.startIndexes.experimentNumber }}, minRelativeIndex=0, maxRelativeIndex=float('inf'))
										</p>
										
									</v-card>
									
								</v-card>
							</v-stepper-content>
						</v-stepper-items>
					</v-stepper>
					
					
					<v-flex xs12 class="ma-3" v-if="topLevelPage == 'scheduleCreator'">
						<v-card class="mb-3">
							<v-toolbar dark class="blue-grey darken-1">
								<v-toolbar-title>
									Load Schedule File
								</v-toolbar-title>
							</v-toolbar>
							<!-- <v-menu attach bottom left offset-y>
								<v-btn slot="activator" flat>{{ scheduleSaveUser }}<v-icon right>people</v-icon></v-btn>
								<v-list light>
									<v-list-tile v-for="u in users" @click="scheduleSaveUser = u">
										<v-list-tile-avatar color="blue-grey lighten-2"><v-icon dark>account_circle</v-icon></v-list-tile-avatar>
										<v-list-tile-content><v-list-tile-title>{{ u }}</v-list-tile-title></v-list-tile-content>
									</v-list-tile>
								</v-list>
							</v-menu> -->
							
							<v-form>
								<v-container>
									<v-layout row wrap>
										<v-flex xs12 sm6 md4 lg3 outline>
											<v-autocomplete clearable v-model="scheduleLoadUser" label="User" :items="Object.keys(scheduleNames)"></v-autocomplete>
										</v-flex>
										<v-flex xs12 sm6 md4 lg3 solo>
											<v-autocomplete clearable v-model="scheduleLoadProject" label="Project" :items="_.keys(_.get(scheduleNames, [scheduleLoadUser], {}))"></v-autocomplete>
										</v-flex>
										<v-flex xs12 sm6 md4 lg3 solo>
											<v-autocomplete clearable v-model="scheduleLoadFileName" label="File Name" :items="_.get(scheduleNames, [scheduleLoadUser, scheduleLoadProject], [])"></v-autocomplete>
										</v-flex>
									</v-layout>
								</v-container>
							</v-form>
							
							<v-card-actions>
								<span v-if="scheduleLoadUser && scheduleLoadProject && scheduleLoadFileName">Loading from: AutexysData/{{ scheduleLoadUser }}/{{ scheduleLoadProject }}/schedules/{{ scheduleLoadFileName }}.json</span>
								<v-spacer></v-spacer>
								<v-btn @click="loadSchedule()">Load Schedule File</v-btn>
							</v-card-actions>
						</v-card>
						
						
						<v-card class="mb-3">
							<v-toolbar dark class="blue-grey darken-1">
								<v-toolbar-title>
									Define Jobs
								</v-toolbar-title>
								<v-spacer></v-spacer>
								<v-btn icon @click="scheduleObjects = [JSON.parse(JSON.stringify(scheduleObjectDefault))]">
									<v-icon>settings_backup_restore</v-icon>
								</v-btn>
							</v-toolbar>
							
							
							<v-list expand>
								<v-list-group v-for="scheduleObject, scheduleObjectIndex in scheduleObjects" :key="scheduleObjectIndex">
									<v-list-tile slot="activator">
										<v-list-tile-content>
											<v-list-tile-title>
												Job {{ scheduleObjectIndex + 1 }}: {{ _.get(scheduleObjects[scheduleObjectIndex], 'runType.default') }}
											</v-list-tile-title>
										</v-list-tile-content>
										<v-list-tile-action>
											<v-tooltip top>
												<v-btn icon @click.stop="moveScheduleJobUp(scheduleObjectIndex)" slot="activator" :disabled="scheduleObjectIndex == 0"><v-icon>arrow_upward</v-icon></v-btn>
												<span>Move job up</span>
											</v-tooltip>
										</v-list-tile-action>
										<v-list-tile-action>
											<v-tooltip top>
												<v-btn icon @click.stop="moveScheduleJobDown(scheduleObjectIndex)" slot="activator" :disabled="scheduleObjectIndex >= scheduleObjects.length - 1"><v-icon>arrow_downward</v-icon></v-btn>
												<span>Move job down</span>
											</v-tooltip>
										</v-list-tile-action>
										<v-list-tile-action>
											<v-tooltip top>
												<v-btn icon @click.stop="copyScheduleObject(scheduleObjectIndex)" slot="activator"><v-icon>file_copy</v-icon></v-btn>
												<span>Copy job</span>
											</v-tooltip>
										</v-list-tile-action>
										<v-list-tile-action>
											<v-tooltip top>
												<v-btn icon @click.stop="pasteScheduleObject(scheduleObjectIndex)" slot="activator"><v-icon>save_alt</v-icon></v-btn>
												<span>Paste job</span>
											</v-tooltip>
										</v-list-tile-action>
										<v-list-tile-action>
											<v-tooltip top>
												<v-btn icon @click.stop="addScheduleJob(scheduleObjectIndex)" slot="activator"><v-icon>add_circle</v-icon></v-btn>
												<span>Add new job after</span>
											</v-tooltip>
										</v-list-tile-action>
										<v-list-tile-action>
											<v-tooltip top>
												<v-btn icon @click.stop="resetScheduleJob(scheduleObjectIndex)" slot="activator"><v-icon>settings_backup_restore</v-icon></v-btn>
												<span>Reset job settings to defaults</span>
											</v-tooltip>
										</v-list-tile-action>
										<v-list-tile-action>
											<v-tooltip top>
												<v-btn icon @click.stop="removeScheduleJob(scheduleObjectIndex)" slot="activator"><v-icon>cancel</v-icon></v-btn>
												<span>Delete job</span>
											</v-tooltip>
										</v-list-tile-action>
									</v-list-tile>
									<v-container fluid grid-list-md>
										<v-layout row wrap>
											
											<v-flex xs12 sm6 md4 lg3 xl2 d-flex>
												<v-card ma-1 tile>
													<v-toolbar dark class="blue-grey lighten-1">
														<v-toolbar-title>
															Parameters
														</v-toolbar-title>
													</v-toolbar>
													
													<v-list>
														<v-select box class="ma-3" label="Run Type" v-model="scheduleObjects[scheduleObjectIndex]['runType']['default']" :items="Object.keys(scheduleObjectDefault['runConfigs'])"></v-select>
														<v-subheader>Identifiers</v-subheader>
														<v-list-tile v-for="(settingDescription, settingName) in scheduleObjectDefault['Identifiers']" v-if="['bool','float','int','string','choice'].includes(settingDescription.type)">
															<v-switch v-if="settingDescription.type == 'bool'" :label="settingName" v-model="scheduleObjects[scheduleObjectIndex]['Identifiers'][settingName]['default']"></v-switch>
															<v-text-field v-if="settingDescription.type == 'float'" :label="settingName" v-model.number="scheduleObjects[scheduleObjectIndex]['Identifiers'][settingName]['default']"></v-text-field>
															<v-text-field v-if="settingDescription.type == 'int'" :label="settingName" v-model.number="scheduleObjects[scheduleObjectIndex]['Identifiers'][settingName]['default']"></v-text-field>
															<v-text-field v-if="settingDescription.type == 'string'" :label="settingName" v-model="scheduleObjects[scheduleObjectIndex]['Identifiers'][settingName]['default']"></v-text-field>
															<v-select v-if="settingDescription.type == 'choice'" :label="settingName"  v-model="scheduleObjects[scheduleObjectIndex]['Identifiers'][settingName]['default']" :items="settingDescription.choices"></v-select>
														</v-list-tile>
														
														<v-subheader>Measurement System</v-subheader>
														<v-list-tile v-for="(settingDescription, settingName) in scheduleObjectDefault['MeasurementSystem']" v-if="['bool','float','int','string','choice','array'].includes(settingDescription.type)" style="overflow:scroll; overscroll-behavior: contain">
															<v-switch v-if="settingDescription.type == 'bool'" :label="settingName"
																v-model="scheduleObjects[scheduleObjectIndex]['MeasurementSystem'][settingName]['default']"></v-switch>
															<v-text-field v-if="settingDescription.type == 'float'" :label="settingName"
																v-model="scheduleObjects[scheduleObjectIndex]['MeasurementSystem'][settingName]['default']"></v-text-field>
															<v-text-field v-if="settingDescription.type == 'int'" :label="settingName"
																v-model="scheduleObjects[scheduleObjectIndex]['MeasurementSystem'][settingName]['default']"></v-text-field>
															<v-text-field v-if="settingDescription.type == 'string'" :label="settingName"
																v-model="scheduleObjects[scheduleObjectIndex]['MeasurementSystem'][settingName]['default']"></v-text-field>
															<v-select v-if="settingDescription.type == 'choice'" :label="settingName" :items="settingDescription.choices"
																v-model="scheduleObjects[scheduleObjectIndex]['MeasurementSystem'][settingName]['default']"></v-select>
															<v-combobox v-if="settingDescription.type == 'array'" :label="settingName"
																v-model="scheduleObjects[scheduleObjectIndex]['MeasurementSystem'][settingName]['default']" :items="scheduleObjects[scheduleObjectIndex]['MeasurementSystem'][settingName]['choices']" multiple small-chips></v-combobox>
														</v-list-tile>
													</v-list>
												</v-card>
											</v-flex>
											
											<v-flex xs12 sm6 md4 lg3 xl2 d-flex v-if="scheduleObjects[scheduleObjectIndex]['runType']['default'] != ''">
												<v-card ma-1 tile>
													<v-toolbar dark class="blue-grey lighten-1">
														<v-toolbar-title>
															{{ scheduleObjects[scheduleObjectIndex]['runType']['default'] }}
														</v-toolbar-title>
														<v-spacer></v-spacer>
														<v-btn icon @click="scheduleObjects[scheduleObjectIndex]['runConfigs'][scheduleObjects[scheduleObjectIndex]['runType']['default']] = JSON.parse(JSON.stringify(scheduleObjectDefault['runConfigs'][scheduleObjects[scheduleObjectIndex]['runType']['default']]))">
															<v-icon>settings_backup_restore</v-icon>
														</v-btn>
													</v-toolbar>
													<v-list>
														<v-list-tile v-for="(settingDescription, settingName) in scheduleObjectDefault['runConfigs'][scheduleObjects[scheduleObjectIndex]['runType']['default']]" v-if="['bool','float','int','string','choice','array'].includes(settingDescription.type)">
															<v-switch v-if="settingDescription.type == 'bool'" :label="settingName"
																v-model="scheduleObjects[scheduleObjectIndex]['runConfigs'][scheduleObjects[scheduleObjectIndex]['runType']['default']][settingName]['default']"></v-switch>
															<v-text-field v-if="settingDescription.type == 'float'" :label="settingName" :suffix="' ('+_.get(settingDescription,['units'])+')'"
																v-model.number="scheduleObjects[scheduleObjectIndex]['runConfigs'][scheduleObjects[scheduleObjectIndex]['runType']['default']][settingName]['default']"></v-text-field>
															<v-text-field v-if="settingDescription.type == 'int'" :label="settingName + ' ('+_.get(settingDescription,['units'])+')'"
																v-model.number="scheduleObjects[scheduleObjectIndex]['runConfigs'][scheduleObjects[scheduleObjectIndex]['runType']['default']][settingName]['default']" clearable>
																	<v-icon slot="append" @click="scheduleObjects[scheduleObjectIndex]['runConfigs'][scheduleObjects[scheduleObjectIndex]['runType']['default']][settingName]['default'] = JSON.parse(JSON.stringify(scheduleObjectDefault['runConfigs'][scheduleObjects[scheduleObjectIndex]['runType']['default']][settingName]['default']))" v-if="JSON.parse(JSON.stringify(scheduleObjects[scheduleObjectIndex]['runConfigs'][scheduleObjects[scheduleObjectIndex]['runType']['default']][settingName]['default'])) != JSON.parse(JSON.stringify(scheduleObjectDefault['runConfigs'][scheduleObjects[scheduleObjectIndex]['runType']['default']][settingName]['default']))">settings_backup_restore</v-icon>
																</v-text-field>
															<v-text-field v-if="settingDescription.type == 'string'" :label="settingName"
																v-model="scheduleObjects[scheduleObjectIndex]['runConfigs'][scheduleObjects[scheduleObjectIndex]['runType']['default']][settingName]['default']"></v-text-field>
															<v-select v-if="settingDescription.type == 'choice'" :label="settingName" :items="settingDescription.choices"
																v-model="scheduleObjects[scheduleObjectIndex]['runConfigs'][scheduleObjects[scheduleObjectIndex]['runType']['default']][settingName]['default']"></v-select>
															<v-combobox v-if="settingDescription.type == 'array'" :label="settingName"
																v-model="scheduleObjects[scheduleObjectIndex]['runConfigs'][scheduleObjects[scheduleObjectIndex]['runType']['default']][settingName]['default']" :items="[]" multiple small-chips></v-combobox>
														</v-list-tile>
													</v-list>
												</v-card>
											</v-flex>
											
											<v-flex xs12 sm6 md4 lg3 xl2 d-flex v-for="dependency in _.get(scheduleObjectDefault, ['runConfigs', scheduleObjects[scheduleObjectIndex]['runType']['default'], 'dependencies', 'value'])">
												<v-card ma-1 tile>
													<v-toolbar dark class="blue-grey lighten-1">
														<v-toolbar-title>
															{{ dependency }}
														</v-toolbar-title>
														<v-spacer></v-spacer>
														<v-btn icon @click="scheduleObjects[scheduleObjectIndex]['runConfigs'][dependency] = JSON.parse(JSON.stringify(scheduleObjectDefault['runConfigs'][dependency]))">
															<v-icon>settings_backup_restore</v-icon>
														</v-btn>
													</v-toolbar>
													<v-list>
														<v-list-tile v-for="(settingDescription, settingName) in scheduleObjectDefault['runConfigs'][dependency]" v-if="['bool','float','int','string','choice','array'].includes(settingDescription.type)">
															<v-switch v-if="settingDescription.type == 'bool'" :label="settingName"
																v-model="scheduleObjects[scheduleObjectIndex]['runConfigs'][dependency][settingName]['default']"></v-switch>
															<v-text-field v-if="settingDescription.type == 'float'" :label="settingName" :suffix="' ('+_.get(settingDescription,['units'])+')'"
																v-model.number="scheduleObjects[scheduleObjectIndex]['runConfigs'][dependency][settingName]['default']"></v-text-field>
															<v-text-field v-if="settingDescription.type == 'int'" :label="settingName" :suffix="' ('+_.get(settingDescription,['units'])+')'"
																v-model.number="scheduleObjects[scheduleObjectIndex]['runConfigs'][dependency][settingName]['default']"></v-text-field>
															<v-text-field v-if="settingDescription.type == 'string'" :label="settingName"
																v-model="scheduleObjects[scheduleObjectIndex]['runConfigs'][dependency][settingName]['default']"></v-text-field>
															<v-select v-if="settingDescription.type == 'choice'" :label="settingName" :items="settingDescription.choices"
																v-model="scheduleObjects[scheduleObjectIndex]['runConfigs'][dependency][settingName]['default']"></v-select>
															<v-combobox v-if="settingDescription.type == 'array'" :label="settingName"
																v-model="scheduleObjects[scheduleObjectIndex]['runConfigs'][dependency][settingName]['default']" :items="[]" multiple small-chips></v-combobox>
														</v-list-tile>
													</v-list>
												</v-card>
											</v-flex>
										</v-layout>
									</v-container>
								</v-list-group>
							</v-list>
							<!-- <v-btn fab small dark bottom right absolute @click="addScheduleJob()"><v-icon>add</v-icon></v-btn> -->
						</v-card>
						
						<v-card class="mb-3" tile>
							<v-toolbar dark class="blue-grey darken-1">
								<v-toolbar-title>
									Preview Schedule File
								</v-toolbar-title>
							</v-toolbar>
							<v-card-text class="text-no-wrap" style="overflow-x: scroll">
								<template v-for="schedLine in scheduleLines">
									{{ schedLine }} <br>
								</template>
							</v-card-text>
							
							<v-card v-for="scheduleObject, scheduleObjectIndex in scheduleObjects">
								<v-chip color="secondary" text-color="white" v-if="scheduleObject['runType']['default'] != ''">
									{{ scheduleObject['runType']['default'] }}
								</v-chip>
								<v-chip color="primary" text-color="white" v-for="(settingDescription, settingName) in scheduleObjectDefault['runConfigs'][scheduleObjects[scheduleObjectIndex]['runType']['default']]" v-if="scheduleObjects[scheduleObjectIndex]['runConfigs'][scheduleObjects[scheduleObjectIndex]['runType']['default']][settingName]['default'] != scheduleObjectDefault['runConfigs'][scheduleObjects[scheduleObjectIndex]['runType']['default']][settingName]['default']">
									{{ settingName }}
								</v-chip>
							</v-card>
						</v-card>
						
						<v-card class="mb-3" tile>
							<v-toolbar dark class="blue-grey darken-1">
								<v-toolbar-title>
									Save Schedule File
								</v-toolbar-title>
							</v-toolbar>
							
							<v-form>
								<v-container>
									<v-layout row wrap>
										<v-flex xs12 sm6 md4 lg3 outline>
											<v-combobox clearable v-model="scheduleSaveUser" label="User" :items="Object.keys(scheduleNames)">
												<template slot="no-data">
													<v-list-tile>
														<v-list-tile-content>
															<v-list-tile-title>
																No results. Continuing will create a new user.
															</v-list-tile-title>
														</v-list-tile-content>
												  	</v-list-tile>
												</template>
											</v-combobox>
										</v-flex>
										<v-flex xs12 sm6 md4 lg3 solo>
											<v-combobox clearable v-model="scheduleSaveProject" label="Project" :items="_.keys(_.get(scheduleNames, [scheduleSaveUser], {}))">
												<template slot="no-data">
													<v-list-tile>
														<v-list-tile-content>
															<v-list-tile-title>
																No results. Continuing will create a new project.
															</v-list-tile-title>
														</v-list-tile-content>
												  	</v-list-tile>
												</template>
											</v-combobox>
										</v-flex>
										<v-flex xs12 sm6 md4 lg3 solo>
											<v-combobox clearable v-model="scheduleSaveFileName" label="File Name" :items="_.get(scheduleNames, [scheduleSaveUser, scheduleSaveProject], [])">
												<template slot="no-data">
													<v-list-tile>
														<v-list-tile-content>
															<v-list-tile-title>
																No results. Continuing will create a new file.
															</v-list-tile-title>
														</v-list-tile-content>
												  	</v-list-tile>
												</template>
											</v-combobox>
										</v-flex>
									</v-layout>
								</v-container>
							</v-form>
							
							<template v-if="scheduleSaveUser && scheduleSaveProject && scheduleSaveFileName">
								<p><i>Saving to:</i> AutexysData/{{ scheduleSaveUser }}/{{ scheduleSaveProject }}/schedules/{{ scheduleSaveFileName }}.json</p>
								<p>
									<i>Run by executing:</i><br/>
									cd "{{ paths['sourceAbsPath'] }}"<br/>
									python dispatcher.py "../../AutexysData/{{ scheduleSaveUser }}/{{ scheduleSaveProject }}/schedules/{{ scheduleSaveFileName }}.json"
								</p>
							</template>
							
							<v-card-actions>
								<v-spacer></v-spacer>
								<v-btn @click="saveSchedule()">Save Schedule File</v-btn>
							</v-card-actions>
						</v-card>
						
					</v-flex>
					
					<v-flex xs12 class="ma-3" v-if="topLevelPage == 'settings'">
						<v-card>
							<v-toolbar dark class="blue-grey darken-1">
								<v-toolbar-title>
									Settings
								</v-toolbar-title>
							</v-toolbar>
							<v-container>
								<p>
									Settings page coming soon.
								</p>
							</v-container>
						</v-card>
					</v-flex>
					
					<v-flex xs12 class="ma-3" v-if="topLevelPage == 'dashboard'">
						<v-card>
							<v-toolbar dark class="blue-grey darken-1">
								<v-toolbar-title>
									Dashboard
								</v-toolbar-title>
							</v-toolbar>
							<v-container>
								<p>
									Dashboard page coming soon.
								</p>
							</v-container>
						</v-card>
					</v-flex>
					
					<v-flex xs12 class="ma-3" v-if="topLevelPage == 'about'">
						<v-card>
							<v-toolbar dark class="blue-grey darken-1">
								<v-toolbar-title>
									About
								</v-toolbar-title>
							</v-toolbar>
							<v-container>
								<p>
									Autexys - the Automated Experimentation System
								</p>
							</v-container>
						</v-card>
					</v-flex>
					
					<v-flex xs12 class="ma-3" v-if="topLevelPage == 'experimentRunner'">
						<v-card>
							<v-toolbar dark class="blue-grey darken-1">
								<v-toolbar-title>
									Experiment Runner
								</v-toolbar-title>
							</v-toolbar>
							<v-container>
								
								<v-form>
									<v-container>
										<v-layout row wrap>
											<v-flex xs12 sm6 md4 lg3 outline>
												<v-autocomplete clearable v-model="scheduleExperimentUser" label="User" :items="Object.keys(scheduleNames)"></v-autocomplete>
											</v-flex>
											<v-flex xs12 sm6 md4 lg3 solo>
												<v-autocomplete clearable v-model="scheduleExperimentProject" label="Project" :items="_.keys(_.get(scheduleNames, [scheduleExperimentUser], {}))"></v-autocomplete>
											</v-flex>
											<v-flex xs12 sm6 md4 lg3 solo>
												<v-autocomplete clearable v-model="scheduleExperimentFileName" label="File Name" :items="_.get(scheduleNames, [scheduleExperimentUser, scheduleExperimentProject], [])"></v-autocomplete>
											</v-flex>
										</v-layout>
									</v-container>
								</v-form>
								
								<v-card-actions>
									<span v-if="scheduleExperimentUser && scheduleExperimentProject && scheduleExperimentFileName">Launch file: AutexysData/{{ scheduleExperimentUser }}/{{ scheduleExperimentProject }}/schedules/{{ scheduleExperimentFileName }}.json</span>
									<v-spacer></v-spacer>
									<v-btn @click="dispatchSchedule()">Launch Experiments in Schedule File</v-btn>
									<v-btn @click="stopAtNextJob()">Stop at Next Job</v-btn>
								</v-card-actions>
								
							</v-container>
						</v-card>
					</v-flex>
					
				</v-content>
				<v-footer inset>
					<v-spacer></v-spacer><span class="pr-3">Created by Steven Noyce. Updated October 2018.</span>
				</v-footer>
			</v-app>
		</transition>
	</div>
	
	
	<script src="/ui/jquery.js"></script>
	<script src="/ui/lodash.js"></script>
	<script src="/ui/vue.js"></script>
	<script src="/ui/vuetify.js"></script>
	<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
	<script type="text/javascript">
		
		var socket = io.connect('http://' + document.domain + ':' + location.port);
		socket.on('connect', function(s) {
			console.log('Emiting my event');
			socket.emit('my event', {data: 'Client is connected'});
		});
		
		socket.on('Server Message', function(message) {
			console.log('Receiving Server Message: ' + JSON.stringify(message));
		});
		
		function groupBy(elements, groupKey) {
			return elements.reduce(function(rv, x) {
				(rv[x[groupKey]] = rv[x[groupKey]] || []).push(x);
				return rv;
			}, {});
		}
		
		// should identifiers span jobs? Give option?
		// What about other things, like device range?
		// click on stepper header causes refresh of section
		
		const get = path => object => path.reduce((xs, x) => (xs && xs[x]) ? xs[x] : null, object);
		
		function objectDeepDiff(object, base) {
			function changes(object, base) {
				return _.transform(object, function(result, value, key) {
					if (!_.isEqual(value, base[key])) {
						result[key] = (_.isObject(value) && _.isObject(base[key])) ? changes(value, base[key]) : value;
					}
				});
			}
			return changes(object, base);
		}
		
		function extractDefaults(obj) {
			var d = JSON.parse(JSON.stringify(obj));
			
			if (!_.isPlainObject(d)) {
				return d;
			}
			if (Object.keys(d).includes('default')) {
				console.log('returning the default');
				return d['default'];
			}
			if (_.isPlainObject(d) && Object.keys(d).length > 0) {
				return Object.assign(...Object.entries(d)
					.filter(([k, v]) => (!Object.keys(v).includes('ignore')))
					.map(([k, v]) => ({[k]: extractDefaults(v)})));
			}
			return d;
		}
		
		var imageRequestsLoading = 0;
		var imageLoaderTimer = setInterval(function() {
			if (imageRequestsLoading > 0) return;
			if (imageRequestsLoading < 0) imageRequestsLoading = 0;
			
			let zoomableImages = document.getElementsByClassName("zoomableImage");
			
			for (var i = 0; i < zoomableImages.length; i++) {
				if (zoomableImages[i].getAttribute('data-src') != zoomableImages[i].getAttribute('src')) {
					zoomableImages[i].setAttribute('src', zoomableImages[i].getAttribute('data-src'));
					
					imageRequestsLoading++;
					
					zoomableImages[i].onload = function() {
						imageRequestsLoading--;
					}
					zoomableImages[i].onerror = function() {
						imageRequestsLoading--;
					}
				}
				if (!zoomableImages[i].complete) {
					return;
				}
			}
		}, 100)
		
		Vue.component('zoomable-image', {
			data: function() {
				return {
					zoomActive: false
				}
			},
			props: ['src'],
			template: '<img :src="src" v-bind:class="{ zoomedImage: zoomActive, zoomableImage: !zoomActive }" @click="zoomActive = !zoomActive">'
			//.getBoundingClientRect();
		});
		
		var app = new Vue({
			el: '#app',
			data: {
				pageLoading: true,
				currentPage: window.location.hash.substr(1) || "",
				drawer: null,
				online: navigator.onLine,
				stepperPage: localStorage.stepperPage ? JSON.parse(localStorage.stepperPage) : 1,
				topLevelPage: localStorage.topLevelPage ? JSON.parse(localStorage.topLevelPage) : 'stepper',
				pageNames: ['projects','wafers','chips','devices','experiments','experiment'],
				parametersTab: 0,
				parametersSection: '',
				cacheBust: '',
				
				defaultPlotSettings: {
					'minExperiment': null,
					'maxExperiment': null,
					'figureSize': null,
					'sweepDirection': 'both',
					'minRelativeIndex': 0,
					'maxRelativeIndex': 1e10,
					'plot_mode_parameters': null
				},
				
				setPlotSettings: {
					'minExperiment': null,
					'maxExperiment': null,
					'figureSize': null,
					'sweepDirection': 'both',
					'minRelativeIndex': 0,
					'maxRelativeIndex': 1e10,
					'plot_mode_parameters': null
				},
				
				plotSettings: {
					'minExperiment': null,
					'maxExperiment': null,
					'figureSize': null,
					'sweepDirection': 'both',
					'minRelativeIndex': 0,
					'maxRelativeIndex': 1e10,
					'plot_mode_parameters': null
				},
				
				plotSettingTypes: {
					'minExperiment': {'type': 'int'},
					'maxExperiment': {'type': 'int'},
					'figureSize': {'type': 'array'},
					'sweepDirection': {'type': 'choice', 'choices': ['both', 'forward', 'reverse']},
					'minRelativeIndex': {'type': 'int'},
					'maxRelativeIndex': {'type': 'int'},
					'plot_mode_parameters': {'type': 'object'}
				},
				
				users: [],
				user: localStorage.user ? JSON.parse(localStorage.user) : '',
				
				projects: [],
				project: localStorage.project ? JSON.parse(localStorage.project) : '',
				projectTableHeaders: [
					{'text':'Name', 'value':'name'}],
				projectTableSearch: '',
				
				wafers: [],
				wafer: localStorage.wafer ? JSON.parse(localStorage.wafer) : '',
				waferTableHeaders: [
					{'text':'Name', 'value':'name'},
					{'text':'Path', 'value':'path', 'searchable':false},
					{'text':'Modification Time', 'value':'modificationTime', 'searchable':false},
					{'text':'Size', 'value':'size', 'searchable':false},
					{'text':'Tested Chips', 'value':'chipCount', 'searchable':false},
					{'text':'Indexes', 'value':'indexCount', 'searchable':false},
					{'text':'Experiments', 'value':'experimentCount', 'searchable':false}],
				waferTableSearch: '',
				
				chips: [],
				chip: localStorage.chip ? JSON.parse(localStorage.chip) : '',
				chipTableHeaders: [
					{'text':'Name', 'value':'name'},
					{'text':'Path', 'value':'path', 'searchable':false},
					{'text':'Modification Time', 'value':'modificationTime', 'searchable':false},
					{'text':'Size', 'value':'size', 'searchable':false},
					{'text':'Tested Devices', 'value':'deviceCount', 'searchable':false},
					{'text':'Indexes', 'value':'indexCount', 'searchable':false},
					{'text':'Experiments', 'value':'experimentCount', 'searchable':false}],
				chipTableSearch: '',
				
				devices: [],
				device: localStorage.device ? JSON.parse(localStorage.device) : '',
				deviceTableHeaders: [
					{'text':'Name', 'value':'displayName'},
					{'text':'Path', 'value':'path', 'searchable':false},
					{'text':'Modification Time', 'value':'modificationTime', 'searchable':false},
					{'text':'Size', 'value':'size', 'searchable':false},
					{'text':'Indexes', 'value':'indexCount', 'searchable':false},
					{'text':'Experiments', 'value':'experimentCount', 'searchable':false}],
				deviceTableSearch: '',
				
				experiments: [],
				experimentIndex: localStorage.experimentIndex ? JSON.parse(localStorage.experimentIndex) : 0,
				experimentTableHeaders: [
					{'text':'Experiment Number', 'value':'startIndexes.experimentNumber'},
					{'text':'Run Type', 'value':'runType'},
					{'text':'Measurement System', 'value':'MeasurementSystem.systemType'},
					{'text':'Indexes', 'value':'uiComputed.indexCount'}],
				experimentTableSearch: '',
				experimentTablePagination: {'sortBy': 'startIndexes.experimentNumber', 'descending': true},
				
				indexes: [],
				
				possibleRunTypes: ['GateSweep', 'AutoGateSweep', 'StaticBias', 'AutoStaticBias'],
				defaultParameters: {},
				parameters: {},
				parametersDescription: {},
				scheduleObjects: localStorage.scheduleObjects ? JSON.parse(localStorage.scheduleObjects) : {},
				scheduleObjectDefault: {},
				scheduleObjectClipboard: localStorage.scheduleObjectClipboard ? JSON.parse(localStorage.scheduleObjectClipboard) : {},
				scheduleSaveUser: '',
				scheduleSaveProject: '',
				scheduleSaveFileName: '',
				scheduleLoadUser: '',
				scheduleLoadProject: '',
				scheduleLoadFileName: '',
				scheduleExperimentUser: '',
				scheduleExperimentProject: '',
				scheduleExperimentFileName: '',
				scheduleExperimentSuccessCode: {},
				saveScheduleSuccessCode: {},
				scheduleNames: {},
				addToNoteSuccessCode: {},
				paths: {},
				disabledPlots: localStorage.disabledPlots ? JSON.parse(localStorage.disabledPlots) : [],
				possibleChipPlots: []
			},
			methods: {
				
				getAll: function() {
					this.getUsers();
					this.getProjects();
					this.getWafers();
					this.getChips();
					this.getDevices();
					this.getExperiments();
					this.getDefaultParameters();
					this.getScheduleNames();
					this.getPaths();
					this.getPossibleChipPlots();
					
					this.pageLoading = false;
					this.newCacheBust();
					this.getAssociatedAFMs();
				},
				
				getUsers: function() {
					var path = "/users.json" + this.cacheBust;
					if (path) {
						$.getJSON(path, response => {this.users = response})
						.fail(() => {console.log("Error getting users")});
					}
				},
				getProjects: function() {
					var path = '/' + this.user + '/projects.json' + this.cacheBust;
					if (path) {
						$.getJSON(path, response => {app.$data.projects = response})
						.fail(() => {console.log("Error getting projects")});
					}
				},
				getWafers: function() {
					var path = '/' + this.user + '/' + this.project + '/wafers.json' + this.cacheBust;
					if (path) {
						$.getJSON(path, response => {app.$data.wafers = response})
						.fail(() => {console.log("Error getting wafers")});
					}
					
					this.getIndexes();
				},
				getChips: function() {
					var path = '/' + this.user + '/' + this.project + '/' + this.wafer + '/chips.json' + this.cacheBust;
					if (path) {
						$.getJSON(path, response => {app.$data.chips = response})
						.fail(() => {console.log("Error getting chips")});
					}
				},
				getPossibleChipPlots: function() {
					var path = '/' + this.user + '/' + this.project + '/' + this.wafer + '/' + this.chip + '/availableChipPlots.json' + this.cacheBust;
					if (path) {
						$.getJSON(path, response => {app.$data.possibleChipPlots = response})
						.fail(() => {console.log("Error getting possible chip plots")});
					}
				},
				getDevices: function() {
					var path = '/' + this.user + '/' + this.project + '/' + this.wafer + '/' + this.chip + '/devices.json' + this.cacheBust;
					if (path) {
						$.getJSON(path, response => {
							response.map(function(device) {
								var contacts = device.name.match(/\d+/g).map(num => num.padStart(2, '0'));
								device.displayName = contacts.join('-');
								return device;
							});
							app.$data.devices = response;
						})
						.fail(() => {console.log("Error getting devices")});
					}
				},
				getExperiments: function() {
					var path = '/' + this.user + '/' + this.project + '/' + this.wafer + '/' + this.chip + '/' + this.device + '/experiments.json' + this.cacheBust;
					if (path) {
						$.getJSON(path, response => {
							console.log("Starting to receive experiments");
							for (var i = 0; i < response.length; i++) {
								response[i]['uiComputed'] = {};
								response[i]['uiComputed']['indexCount'] = response[i]['endIndexes']['index'] - response[i]['startIndexes']['index'];
							}
							app.$data.experiments = response;
							
							// let lastExperiment = this.experiments[this.experiments.length - 1];
							// let lastFinishedIndex = lastExperiment['endIndexes']['index'];
							// let lastIndexObject = this.indexes[this.wafer][this.chip][this.device];
							// let lastIndex = lastIndexObject['index'];
							
							// if (lastIndex > lastFinishedIndex) {
							// 	let currentExperiment = JSON.parse(JSON.stringify(lastExperiment));
							// 	currentExperiment['startIndexes'] = JSON.parse(JSON.stringify(lastExperiment['startIndexes']));
							// 	currentExperiment['startIndexes']['experimentNumber']++;
							// 	currentExperiment['endIndexes'] = JSON.parse(JSON.stringify(lastIndexObject));
							// 	currentExperiment['runType'] = 'Running';
							// 	this.experiments.push(currentExperiment);
							// }
						})
						.fail(function(jqXHR, textStatus, errorThrown) { console.log('getJSON request failed! ' + textStatus + ' ' + errorThrown); });
						//.fail(() => {console.log("Error getting experiments");});
					}
				},
				getExperiment: function() {
					// $.getJSON('/' + this.wafer + '/' + this.chip + '/' + this.device + '/' + this.experiment + '/?.json', response => {app.$data.experiments = response}).fail(() => {console.log("Error getting devices")});
				},
				getIndexes: function() {
					var path = '/' + this.user + '/' + this.project + '/indexes.json' + this.cacheBust;
					if (path) {
						$.getJSON(path, response => {app.$data.indexes = response})
						.fail(() => {console.log("Error getting indexes")});
					}
				},
				getDefaultParameters() {
					$.getJSON("/defaultParameters.json" + this.$data.cacheBust, response => {
						this.$data.defaultParameters = response;
						this.$data.parameters = JSON.parse(JSON.stringify(response));
					}).fail(() => {console.log("Error getting default parameters")});
					
					$.getJSON("/parametersDescription.json" + this.$data.cacheBust, response => {
						this.$data.parametersDescription = response;
						this.$data.scheduleObjectDefault = JSON.parse(JSON.stringify(response));
						this.$data.scheduleObjects = [JSON.parse(JSON.stringify(response))];
					}).fail(() => {console.log("Error getting parameters description")});
				},
				getScheduleNames: function() {
					var path = '/scheduleNames.json' + this.cacheBust;
					if (path) {
						$.getJSON(path, response => {app.$data.scheduleNames = response})
						.fail(() => {console.log("Error getting schedule names")});
					}
				},
				getAssociatedAFMs: function() {
					var experiment = this.experiments[this.experimentIndex];
					
					if (!(experiment.runType.includes('AFM') || experiment.runType.includes('SGM'))) {
						experiment.associatedAFMs = {};
						return;
					}
					
					startTime = experiment.startIndexes.timestamp;
					endTime = experiment.endIndexes.timestamp;
					var path = '/AFMFilesInTimestampRange/' + startTime + '/' + endTime + '/associatedAFMs.json' + this.cacheBust;
					if (path) {
						$.getJSON(path, response => {Vue.set(experiment, 'associatedAFMs', response)})
						.fail((xhr, status, error) => {console.log("Error getting associated AFMs"); console.log(error)});
					}
				},
				getPaths: function() {
					var path = '/paths.json' + this.cacheBust;
					if (path) {
						$.getJSON(path, response => {app.$data.paths = response})
						.fail(() => {console.log("Error getting paths")});
					}
				},
				
				addToNote: function(experiment) {
					var url = '/addToNote'
					
					$.post(url, JSON.stringify(experiment), response => {
						this.addToNoteSuccessCode = response;
						this.experiment.noteAddition = '';
					}).fail(() => {console.log("Error adding to note")});
				},
				
				saveSchedule: function() {
					var url = '/saveSchedule/' + this.scheduleSaveUser + '/' + this.scheduleSaveProject + '/' + this.scheduleSaveFileName;
					url += this.cacheBust;
					// url += '&jobs=' + encodeURI(JSON.stringify(this.scheduleObjectDefault));
					
					$.post(url, JSON.stringify(this.scheduleLines), response => {
						this.saveScheduleSuccessCode = response;
					}).fail(() => {console.log("Error saving schedule file")});
					
					// $.getJSON(url, JSON.stringify(this.scheduleObjectDefault), response => {
					// 	this.saveScheduleSuccessCode = response;
					// }).fail(() => {console.log("Error saving schedule file")});
					
					if (this.scheduleExperimentUser == '') this.scheduleExperimentUser = this.scheduleSaveUser;
					if (this.scheduleExperimentProject == '') this.scheduleExperimentProject = this.scheduleSaveProject;
					if (this.scheduleExperimentFileName == '') this.scheduleExperimentFileName = this.scheduleSaveFileName;
					
					this.getScheduleNames();
				},
				loadSchedule: function() {
					var path = '/scheduleFiles/' + this.scheduleLoadUser + '/' + this.scheduleLoadProject + '/' + this.scheduleLoadFileName + '.json' + this.cacheBust;
					if (path) {
						$.getJSON(path, response => {app.$data.scheduleObjects = response})
						.fail(() => {console.log("Error loading schedule file")});
					}
					
					if (this.scheduleSaveUser == '') this.scheduleSaveUser = this.scheduleLoadUser;
					if (this.scheduleSaveProject == '') this.scheduleSaveProject = this.scheduleLoadProject;
					if (this.scheduleSaveFileName == '') this.scheduleSaveFileName = this.scheduleLoadFileName;
				},
				dispatchSchedule: function() {
					var path = '/dispatchSchedule/' + this.scheduleExperimentUser + '/' + this.scheduleExperimentProject + '/' + this.scheduleExperimentFileName + '.json' + this.cacheBust;
					if (path) {
						$.getJSON(path, response => {app.$data.scheduleExperimentSuccessCode = response})
						.fail(() => {console.log("Error dispatching schedule file")});
					}
				},
				stopAtNextJob: function() {
					var path = '/stopAtNextJob' + this.cacheBust;
					if (path) {
						$.getJSON(path, response => {app.$data.stopAtNextJobSuccessCode = response})
						.fail(() => {console.log("Error stopping at next job")});
					}
				},
				updateAFMRegistry: function() {
					var path = '/updateAFMRegistry' + this.cacheBust;
					if (path) {
						$.getJSON(path, response => {
							if (response['success']) {
								app.$data.updateAFMRegistryTime = new Date();
							}
						}).fail(() => {console.log("Error updaing AFM registry")});
					}
				},
				
				goToUser: function(userName) {
					this.user = userName;
					localStorage.user = JSON.stringify(userName);
					this.getProjects();
				},
				goToProject: function(projectName) {
					this.project = projectName;
					localStorage.project = JSON.stringify(projectName);
					this.getWafers();
					this.stepperPage++;
				},
				goToWafer: function(waferName) {
					this.wafer = waferName;
					localStorage.wafer = JSON.stringify(waferName);
					this.getChips();
					this.stepperPage++;
				},
				goToChip: function(chipName) {
					this.chip = chipName;
					localStorage.chip = JSON.stringify(chipName);
					this.getDevices();
					this.stepperPage++;
				},
				goToDevice: function(deviceName) {
					this.device = deviceName;
					localStorage.device = JSON.stringify(deviceName);
					this.getExperiments();
					this.stepperPage++;
				},
				goToExperiment: function(experimentIndex) {
					this.experimentIndex = experimentIndex;
					localStorage.experimentIndex = JSON.stringify(experimentIndex);
					// this.experiment = experimentParameters;
					this.parametersTab = this.experiments[experimentIndex].runType;
					this.parametersSection = this.experiments[experimentIndex].runType;
					this.getExperiment();
					
					this.stepperPage++;
				},
				
				customVDataTableFilter: function(items, search, filter, headers) {
					search = search.toString().toLowerCase();
					if (search.trim() === '') return items;
					
					// const props = headers.map(h => h.value); // default
					const props = headers.filter(h => !('searchable' in h) || h.searchable === true).map(h => h.value); // exclude searchable:false
					// const props = headers.filter(h => h.searchable === true).map(h => h.value); // include searchable:true
					
					return items.filter(item => props.some(prop => filter(_.get(item, prop), search)));
				},
				newCacheBust: function() {
					var cacheBust = '?cb=' + new Date().getTime();
					this.cacheBust = cacheBust;
					return cacheBust;
				},
				setTopLevelPage: function(name) {
					this.topLevelPage = name;
					localStorage.topLevelPage = JSON.stringify(name);
				},
				
				copyHTMLStringToClip: function (str) {
					function listener(e) {
						e.clipboardData.setData("text/html", str);
						e.clipboardData.setData("text/plain", str);
						e.preventDefault();
					}
					document.addEventListener("copy", listener);
					document.execCommand("copy");
					document.removeEventListener("copy", listener);
				},
				
				copyHTMLImageToClip: function (path) {
					path = window.location.origin + path;
					this.copyHTMLStringToClip('<img src="' + path + '" width="200">');
				},
				
				addScheduleJob: function(index) {
					this.scheduleObjects.splice(index, 0, JSON.parse(JSON.stringify(this.scheduleObjects[index])));
					// this.scheduleObjects.push(JSON.parse(JSON.stringify(this.scheduleObjects.slice(-1)[0])));
				},
				
				removeScheduleJob: function(index) {
					this.scheduleObjects.splice(index, 1);
					// this.scheduleObjects.splice(index, 0, JSON.parse(JSON.stringify(this.scheduleObjects[index])));
					// this.scheduleObjects.push(JSON.parse(JSON.stringify(this.scheduleObjects.slice(-1)[0])));
				},
				
				resetScheduleJob: function(index) {
					this.scheduleObjects.splice(index, 1, JSON.parse(JSON.stringify(this.scheduleObjectDefault)));
				},
				
				moveScheduleJobUp: function(index) {
					var job = this.scheduleObjects[index];
					this.scheduleObjects.splice(index, 1);
					this.scheduleObjects.splice(index-1, 0, job);
				},
				
				moveScheduleJobDown: function(index) {
					var job = this.scheduleObjects[index];
					this.scheduleObjects.splice(index, 1);
					this.scheduleObjects.splice(index+1, 0, job);
				},
				
				copyScheduleObject: function(index) {
					this.scheduleObjectClipboard = JSON.parse(JSON.stringify(this.scheduleObjects[index]));
				},
				
				pasteScheduleObject: function(index) {
					this.scheduleObjects.splice(index, 1, JSON.parse(JSON.stringify(this.scheduleObjectClipboard)))
				},
				
				scheduleObjectDiffFromPrevTwin: function(index) {
					var job = this.scheduleObjects[index];
					// var twin = 
				},
				
				updatePlotSettings: function() {
					this.plotSettings = _.omitBy(this.setPlotSettings, (v,k) => ((this.defaultPlotSettings[k] == v) || v == '') );
				},
				
				removeValueFromArray: function(value, array) {
					while(array.includes(value)) { array.splice( array.indexOf(value), 1 ); }
				}
			},
			watch: {
				stepperPage: function(val) { localStorage.stepperPage = JSON.stringify(val); },
				scheduleObjects: function(val) { localStorage.scheduleObjects = JSON.stringify(val); },
				scheduleObjectClipboard: function(val) { localStorage.scheduleObjectClipboard = JSON.stringify(val); },
				disabledPlots: function(val) { localStorage.disabledPlots = JSON.stringify(val); },
				
				experimentIndex: function(val) { this.getAssociatedAFMs(); }
			},
			computed: {
				experiment: function() {
					if (this.experimentIndex > this.experiments.length) {
						this.experimentIndex = 0;
					}
					return this.experiments[this.experimentIndex];
				},
				experimentsWithIndexes: function() {
					return this.experiments.map((x, i) => { return {...x, i} })
				},
				chipSummaryPlotSettings: function(){

					return null;

				},
				deviceSummaryPlotSettings: function() {
					var settings = _.omitBy(this.setPlotSettings, (v,k) => ((this.defaultPlotSettings[k] == v) || v == '') );
					settings['minExperiment'] = 1;
					settings['maxExperiment'] = 1e10;
					return settings;
					// return this.setPlotSettings;
				},
				defaultRunConfigs: function() {
					return this.defaultParameters['runConfigs'];
				},
				scheduleLine: function() {
					return objectDeepDiff(this.parameters, this.defaultParameters);
				},
				scheduleLines: function() {
					return this.scheduleObjects.map(obj => extractDefaults(objectDeepDiff(obj, this.scheduleObjectDefault)));
				},
				runType: function() {
					return this.parameters['runType'];
				}
			}
		});
		
		app.$vuetify.theme.primary = '#938E94';
		app.$vuetify.theme.secondary = '#557A95';
		app.$vuetify.theme.accent = '#7395AE';
		app.$vuetify.theme.error = '#BF360C';
		app.$vuetify.theme.success = '#00897B';
		app.$vuetify.theme.info = '#B1A296';
		app.$vuetify.theme.warning = '#FFB300';
		
		$( document ).ready(function(){
			
		});
		
		function updateConnectionStatus() {
			app.$set(app, 'online', navigator.onLine);
		}
		
		window.addEventListener('online', updateConnectionStatus);
		window.addEventListener('offline', updateConnectionStatus);
		window.onhashchange = function() { app.$data.currentPage = location.hash; };
		
		if (typeof(Storage) !== 'undefined') {
			localStorage.exists = JSON.stringify('True');
		}
		
		app.getAll();
		
	</script>
</body>
</html>


